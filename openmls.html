<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="description" content="Calcite Maps - ArcGIS 4.x SDK Sample">
    <link rel="icon" href="http://www.esri.com/favicon.ico">
    <title>Calcite Maps - ArcGIS JS 4.0 Example</title>
    <!-- Calcite Bootstrap -- THis is a esri template based on bootstrap that might be useful https://github.com/Esri/calcite-maps-->
    <link rel="stylesheet" href="http://esri.github.com/calcite-maps/dist/css/calcite-bootstrap.min-v0.2.css">
    <!-- Calcite Maps -->
    <link rel="stylesheet" href="http://esri.github.com/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">
    <style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    .esri-legend {
        overflow: hidden;
    }

    .esri-view-height-medium .esri-popup .esri-popup-content {
        max-height: 200px !important;
    }
    /*  This was used to style the popups, a built in feature of the Esri Javascript API
    .esri-view-width-xlarge .esri-popup .esri-popup-main{
        width: 1273px !important;
        height: 841px !important;
    }

    */

    /* stealing drawer CSS from calcite web */
    /* I WILL ORGANIZE CSS and JS a bit better in a close future */
  .drawer {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    visibility: hidden;
    overflow: hidden;
    opacity: 0;
    background: rgba(0, 0, 0, 0.75);
    -webkit-transition: visibility 0ms linear 200ms, opacity 200ms linear;
    transition: visibility 0ms linear 200ms, opacity 200ms linear;
    z-index: 1001; }
  .drawer.is-active {
    visibility: visible;
    opacity: 1;
    background-color: rgba(0, 0, 0, 0.75);
    -webkit-transition-delay: 0ms;
    transition-delay: 0ms; }
    .drawer.is-active.drawer-right .drawer-nav {
      -webkit-transform: translate3d(-400px, 0, 0);
      -moz-transform: translate3d(-400px, 0, 0);
      -ms-transform: translate3d(-400px, 0, 0);
      -o-transform: translate3d(-400px, 0, 0);
      transform: translate3d(-400px, 0, 0); }

  .drawer-nav {
    position: absolute;
    top: 0;
    height: 100%;
    width: 400px;
    margin: 0;
    padding: 60px 10px 10px 10px;
    background: #ffffff;
    overflow-x: hidden;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    -webkit-transform: translate3d(0, 0, 0);
    -moz-transform: translate3d(0, 0, 0);
    -ms-transform: translate3d(0, 0, 0);
    -o-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    -webkit-transition: -webkit- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -moz-transition: -moz- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -o-transition: -o- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    transition: transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88); }

  .drawer-right .drawer-nav {
    left: 100%; }

  .wrapper {
    -webkit-transition: -webkit- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -moz-transition: -moz- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -o-transition: -o- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    transition: transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88); }

  .drawer-right-is-active {
    -webkit-transition: -webkit- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -moz-transition: -moz- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -o-transition: -o- transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    transition: transform 200ms cubic-bezier(0.215, 0.44, 0.42, 0.88);
    -webkit-transform: translate3d(-400px, 0, 0);
    -moz-transform: translate3d(-400px, 0, 0);
    -ms-transform: translate3d(-400px, 0, 0);
    -o-transform: translate3d(-400px, 0, 0);
  transform: translate3d(-400px, 0, 0); }

  .drawer-no-overflow {
    overflow: hidden; }
.innertab{padding:10px;font-size:1.2rem; min-height:400px;border-left:1px solid #a9a9a9;background-color:#f8f8f8}
  .innertab--settings{}
  .innertab--selecteddata{}
  .innertab--cart{}
    </style>
</head>

<body class="calcite-maps calcite-nav-top">
  <div class="drawer drawer-right js-drawer" data-drawer="top-nav" tabName="0">
    <div class="drawer-nav">

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation"><a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Settings</a></li>
    <li role="presentation"><a href="#selecteddata" aria-controls="selecteddata" role="tab" data-toggle="tab">Data</a></li>
    <li role="presentation"><a href="#cart" aria-controls="cart" role="tab" data-toggle="tab">Cart</a></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane" id="settings">
      <div class="innertab innertab--settings">
        <!-- accordion  -->

          <div class="panel-group" id="accordionSettings">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordionSettings" href="#collapseOne">Legend</a></h4></div>
              <div id="collapseOne" class="panel-collapse collapse">
                <div class="panel-body">Legend goes here.</div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordionSettings" href="#collapseTwo">Descriptive Information</a></h4></div>
              <div id="collapseTwo" class="panel-collapse collapse">
                <div class="panel-body">Descriptive info goes here </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordionSettings" href="#collapseThree">Filters</a></h4></div>
              <div id="collapseThree" class="panel-collapse collapse in">
                <div class="panel-body">
                  <form method="post">
                  <div class="row">
                   <div class="col-xs-6">
                     <div class="form-group ">
                      <label class="control-label " for="hgt">
                       Height for MLS data
                      </label>
                      <select class="select form-control" id="hgt" name="hgt">
                       <option value="MLS_Inspections">
                        MLS Inspections
                       </option>
                       <option value="MLS_Violations">
                        MLS Violations
                       </option>
                      </select>
                     </div>
                     <div class="form-group ">
                       <div class="checkbox">
                        <label class="checkbox">
                         <input name="MSL_filters" type="checkbox" value="First Choice"/>
                         First Choice
                        </label>
                       </div>
                       <div class="checkbox">
                        <label class="checkbox">
                         <input name="MSL_filters" type="checkbox" value="Second Choice"/>
                         Second Choice
                        </label>
                       </div>
                       <div class="checkbox">
                        <label class="checkbox">
                         <input name="MSL_filters" type="checkbox" value="Third Choice"/>
                         Third Choice
                        </label>
                       </div>
                     </div>
                     </div>
                     <div class="col-xs-6">
                     <div class="form-group ">
                      <label class="control-label " for="fire">
                       Colors for Fire data
                      </label>
                      <select class="select form-control" id="fire" name="fire">
                      <option value="Fire_Inspections">
                       Fire Inspections
                      </option>
                      <option value="Fire_Violations">
                       Fire Violations
                      </option>
                      </select>
                     </div>
                     <div class="form-group ">
                       <div class="checkbox">
                        <label class="checkbox">
                         <input name="MSL_filters" type="checkbox" value="First Choice"/>
                         First Choice
                        </label>
                       </div>
                       <div class="checkbox">
                        <label class="checkbox">
                         <input name="MSL_filters" type="checkbox" value="Second Choice"/>
                         Second Choice
                        </label>
                       </div>
                       <div class="checkbox">
                        <label class="checkbox">
                         <input name="MSL_filters" type="checkbox" value="Third Choice"/>
                         Third Choice
                        </label>
                       </div>
                     </div>
                   </div>
                  </div>



                  <div class="row">
                   <div class="col-xs-6">
                    <div class="form-group">
                     <div>
                      <button class="btn btn-primary btn-block" name="submit" type="submit">
                       Filter
                      </button>
                     </div>
                    </div>
                  </div>
                  <div class="col-xs-6">
                   <div class="form-group">
                    <div>
                     <button class="btn btn-default btn-block" name="reset">
                      Clear
                     </button>
                    </div>
                   </div>
                  </div>
                  </div>





                  </form>

                </div>
              </div>
            </div>
          </div>
        <!-- / accordion  -->

      </div>
    </div>
    <div role="tabpanel" class="tab-pane" id="selecteddata">
      <div class="innertab innertab--selecteddata">There is no data selected. Click on a building to retrive information.</div>
    </div>
    <div role="tabpanel" class="tab-pane" id="cart">
      <div class="innertab innertab--cart">
        Your cart is empty, you don't have anything to download.
      </div>
    </div>
  </div>
    </div>
  </div>
  <div class="wrapper">
    <!-- Navbar  Here is where you can likely add in a lot of the functionality we talked about, drop downs, radio buttions, shopping cart, table view etc. -->
    <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark calcite-bgcolor-dark-blue">
        <!-- Header -->
        <div class="navbar-header">
            <a class="navbar-brand" role="button" id="calciteToggleNavbar" aria-haspopup="true">
        <span class="esri-icon esri-icon-map-pin"></span>
      </a>
        </div>
        <!-- Title -->
        <div class="calcite-title calcite-overflow-hidden">
            <span class="calcite-title-main">Geocollective</span>
            <span class="calcite-title-divider hidden-xs"></span>
            <span class="calcite-title-sub hidden-xs">Toronto Inspection</span>
        </div>
        <!-- Nav
		I would try to cram as much functionality into this drop down menu, perhaps making is as a collapseable sidebar is ideal.

		-->
        <ul class="calcite-nav nav navbar-nav">
            <li><a href="#" class="js-drawer-toggle" data-drawer="right"><span class="glyphicon glyphicon-list"></span></a></li>
        </ul>
    </nav>
    <!--/.navbar -->
    <!-- Map Container  -->
    <div class="calcite-map calcite-map-absolute">
        <div id="mapViewDiv"></div>
    </div>
    <!-- /.container -->
    <script type="text/javascript">
    var dojoConfig = {
        packages: [{
                name: "bootstrap",
                location: "http://esri.github.com/calcite-maps/dist/vendor/dojo-bootstrap"
            },
            {
                name: "calcite-maps",
                location: "http://esri.github.com/calcite-maps/dist/js/dojo"
            }
        ]
    };
    </script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.5/esri/css/main.css">
    <script src="https://js.arcgis.com/4.5/"></script>
    <script>
    var dataBank = {};
    require([
        // ArcGIS JS
        "esri/Color",
        "esri/Map",
        "esri/views/SceneView",
        "esri/Camera",
        "esri/layers/GraphicsLayer",

        "esri/Graphic",
        "esri/geometry/Point",
        "esri/geometry/Polyline",
        "esri/geometry/Polygon",

        "esri/symbols/SimpleMarkerSymbol",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleFillSymbol",

        "esri/widgets/Search",
        "esri/widgets/Search/SearchViewModel",
        "esri/widgets/BasemapToggle",
        "esri/widgets/BasemapToggle/BasemapToggleViewModel",
        "dojo/request/xhr",
        "dojo/_base/lang",
        "dojo/dom-style",
        "dojo/query",

        "esri/symbols/Symbol3D",
        "esri/symbols/PointSymbol3D",
        "esri/symbols/ObjectSymbol3DLayer",
        "esri/symbols/PolygonSymbol3D",
        "esri/symbols/ExtrudeSymbol3DLayer",
        "esri/symbols/TextSymbol3DLayer",
        "esri/layers/SceneLayer",
        "esri/layers/FeatureLayer",

        "esri/PopupTemplate",
        "esri/renderers/SimpleRenderer",
        "dojo/promise/all",
        "dojo/on",
        "esri/tasks/support/IdentifyParameters",
        "esri/symbols/LabelSymbol3D",
        // Bootstrap
        "bootstrap/Tab",
        "bootstrap/Collapse",
        // Calcite-maps
        "calcite-maps/calcitemaps-v0.2",
        "dojo/domReady!"
    ], function(Color, Map, SceneView, Camera, GraphicsLayer,
        Graphic, Point, Polyline, Polygon,
        SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol,
        Search, SearchVM, BasemapToggle, BasemapToggleVM, xhr, lang, domStyle, query, Symbol3D,
        PointSymbol3D, ObjectSymbol3DLayer, PolygonSymbol3D, ExtrudeSymbol3DLayer, TextSymbol3DLayer, SceneLayer, PopupTemplate, all, on, IdentifyParameters, LabelSymbol3D, tab,SimpleRenderer, FeatureLayer) {



		var sceneLayer = new SceneLayer({
		//it be nice to hook the tables for addresses with related geoid's for the 3d building layer we have on a feature server here.... alas, not until we work out the address issue
            url: "http://tiles.arcgis.com/tiles/z2tnIkrLQ2BRzr6P/arcgis/rest/services/Toronto_LoD3_3D_Buildings/SceneServer/layers/0"
        });
        var map = new Map({
            basemap: "dark-gray",
            //layers: [sceneLayer]
        });

		//This is the coloring function we talked about. Right now it is hardcoded and needs to be dynamic, using natural breaks classification and select colors/opactity based on user input
		// Colors can be hex values, although [r,g,b,opacity] arrays will probably be most usful.
		// Here is some code to copy from (might be better options out there), for the natural breaks jenks classification https://gist.github.com/tmcw/4969184 is essentially determines with class/color and height to assign
		//based on "attributes" in the data. I.e., inspection/violation counts for MLS and FIRE.
		//picking gradients for colors and logical steps in heights (in meters again) will be iterative processes.
      function colorclass(value) {
          var color;
          if (value < 100) {

              color = "#8dd3c7";
          } else if (value < 150 && value > 100) {

              color = "#80b1d3";
          } else if (value > 150 && value < 175) {

              color = "#ffffb3";
          } else if (value > 175) {
              color = "#bebada";

          } else {
              color = "#decbe4"
          }
          return color
      }

		//here I am reading in the building geometry and attributes, where the buildingID will be. GeoJson structure is [{geometery:{x,y,z},{properties:{'buildingID':X}}},{....}]
        var boundary = "neighbor_hood_polys.geojson";
        var buildings = "buildings2.geojson";
        this.graphics = [];
		//this is the actual array of graphic/geometry objects we see on the map. So you would loop over/filter on this.buildingsLayer
        this.buildingsLayer = new GraphicsLayer();
        map.add(this.buildingsLayer);
        xhr(buildings, {
            handleAs: "json"
        }).then(lang.hitch(this, function(data) {
        //reading buildings json, adding it to buildingsLayer with color,height (those functions you're going to create)
            for (var ctr in data.features) {
                var boundaryPoly = data.features[ctr].geometry.coordinates[0];

                var polygon = new Polygon([boundaryPoly]);
                var elevation = data.features[ctr].properties.HEIGHT_MSL;
                var color = colorclass(elevation);
				//this is the way we will style the buildings. Essentially this when a user changes a field to symbolize by, or, visualize by , we loop over the this.buildingsLayer and change their height/color fill usinge below
                var fill2Symbol = new PolygonSymbol3D({
                    symbolLayers: [new ExtrudeSymbol3DLayer({
                        size: elevation, // in meteres meters in height
                        material: { color: color }
                    })]
                });
				//this is a simple fill example, not being used. But when we dont have a value etc - we can set this to be greyed out etc. We can also set on to be a "highlight" fill when users select a building(s)
                var fillSymbol = new SimpleFillSymbol({
                    color: [139, 139, 139, 0.1],

                    outline: new SimpleLineSymbol({
                        color: [255, 255, 255],
                        width: 1
                    })
                });
				//creating a  polygon graphic, used by the esri webscene to be the building we see on the map. Notice I am assigning an attributes values, which is just a json/dictionary object {'key':"value"}.
				//this is used by the built in funtion to create a popup when the building is clicked. But because we have multiple tables to work with - it might be adventagous to create our own popup table with tables and filtering
				//ability which can be triggered with the raycasting test at the bottom of the script
                var polygonGraphic = new Graphic({
                    geometry: polygon,
                    symbol: fill2Symbol,
                    attributes: { 'ObjectID': ctr, "HEIGHT_MSL": data.features[ctr].properties.HEIGHT_MSL }
                });
                this.buildingsLayer.add(polygonGraphic);
                this.graphics.push(polygonGraphic);
            }
        }));

       /*
		//this is a built in tool, called renderers that would do the coloring/height adjustments for us by attributes,
		but they don't work on the graphicsLayer object class and our data wont fit the "featureclass" data structure..this was my attempt to make it so
	   var renderer = {
            type: "simple", // autocasts as new SimpleRenderer()
            symbol: {
                type: "simple-fill", // autocasts as new SimpleFillSymbol()
                color: [255, 128, 0, 0.5],
            }
        };


        var lyr = new FeatureLayer({
            // create an instance of esri/layers/support/Field for each field object
            fields: [{
                name: "ObjectID",
                alias: "ObjectID",
                type: "oid"
            }, {
                name: "HEIGHT_MSL",
                alias: "HEIGHT_MSL",
                type: "double"
            }],
            objectIdField: "ObjectID",
            geometryType: "polygon",
            spatialReference: { wkid: 4326 },
            source: this.buildingsLayer,
            renderer: renderer // UniqueValueRenderer based on `type` attribute
        });
        map.add(lyr);

		*/


        var view = new SceneView({
            container: "mapViewDiv",
            padding: {
                top: 50
            },
            map: map,
            popup: {

                dockOptions: {
                    // Disables the dock button from the popup
                    buttonEnabled: false,
                    // Ignore the default sizes that trigger responsive docking
                    breakpoint: false,
                }
            },
            camera: new Camera({
                position: new Point({
                    x: -79.261723,
                    y: 43.582808,
                    z: 12660.7049653716385
                }),
                heading: 0.34445102566290225,
                tilt: 82.95536300536367
            })
        });

		// below are the start of a hittest/ray casting function to identify selected buildings by mouse clicks. Being able to select multiple, add to shopping cart, etc. download data etc
		//could be done on creating a selected array, storing bluiding ids from this.buildingsLayer. Also filtering, highlighting, etc. buildings by selection/hit test might be useful.
        view.on("click", function(event) {
            var graphic = new Graphic({
                geometry: event.mapPoint,
                symbol: {
                    type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
                    color: "blue",
                    size: 8,
                    outline: { // autocasts as new SimpleLineSymbol()
                        width: 0.5,
                        color: "darkblue"
                    }
                }
            });
        });
        view.on("click", function(evt) {

            dataBank.buildings = dataBank.buildings||{}
            view.hitTest(evt.screenPoint).then(function(response) {
                if (response.results[0].graphic) {
                    console.log("Top graphic found! Here it is: ", response.results[0].graphic);
                    // open the drawer
                    openDrawer('selecteddata');
                    // check if data aready retrieved
                    if(!dataBank.buildings.hasOwnProperty(response.results[0].graphic.uid)){
                      var inspectionsUrl = 'https://api_to_get.data?buildingID='+response.results[0].graphic.uid;
                      xhr(inspectionsUrl, {
                          handleAs: "json"
                      })
                      .then(
                        // success
                        function(data){
                          // store data in an object so we can access it
                          dataBank.buildings[response.results[0].graphic.uid]=data;
                        displayBuildingData(response.results[0].graphic.uid)
                        },
                        //error
                        function(){

                        }
                      )
                    }
                    // display data from the building in the drawer
                    displayBuildingData(response.results[0].graphic.uid)
                }

                var graphic = response.results[0].graphic;
            });
        });

        function displayBuildingData(uid){
          if(!dataBank.buildings.hasOwnProperty(uid)){
            return false;
          }
        }


















    /**
     * functions related to drawer
     */
      function openDrawer(tabName){
        tabName = tabName||'settings';
         document.getElementsByClassName('js-drawer')[0].classList.add('is-active');
         query('a[href="#'+tabName+'"]').tab('show')
      }
      function closeDrawer(){
         document.getElementsByClassName('js-drawer')[0].classList.remove('is-active');
      }
      function toggleDrawer(){
        if (document.getElementsByClassName('js-drawer')[0].classList.contains('is-active')) {
          closeDrawer()
        } else {
          openDrawer()
        }
      }
      // on button click -> toggle the drawer
      document.getElementsByClassName('js-drawer-toggle')[0].addEventListener('click', toggleDrawer);
      // close the drawer if click on brand
      document.getElementById('calciteToggleNavbar').addEventListener('click', closeDrawer);
      document.onkeydown = function(evt) {
          evt = evt || window.event;
          var isEscape = false;
          if ("key" in evt) {
              isEscape = (evt.key == "Escape" || evt.key == "Esc");
          } else {
              isEscape = (evt.keyCode == 27);
          }
          if (isEscape) {
             closeDrawer();
          }
      };




    });
    </script>
  </div><!-- /.wrapper -->
</body>

</html>
